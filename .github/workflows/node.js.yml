name: WebApp CI/CD

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

jobs:
  validate-code:
    name: Validate Code
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v2
      - name: Validate code syntax
        run: npm run lint || echo "::error::Code validation failed. See workflow logs for details." && exit 1

  build:
    name: Build
    runs-on: ubuntu-latest
    needs: validate-code
    steps:
      - name: Checkout code
        uses: actions/checkout@v2
      - name: Install dependencies
        run: npm install || echo "::error::Failed to install dependencies. See workflow logs for details." && exit 1
      - name: Build application
        run: npm run build || echo "::error::Build failed. See workflow logs for details." && exit 1

  test:
    name: Test
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: Checkout code
        uses: actions/checkout@v2
      - name: Install dependencies
        run: npm install || echo "::error::Failed to install dependencies. See workflow logs for details." && exit 1
      - name: Run tests
        run: npm test || echo "::error::Tests failed. See workflow logs for details." && exit 1

  deploy:
    name: Deploy
    runs-on: ubuntu-latest
    needs: test
    steps:
      - name: Checkout code
        uses: actions/checkout@v2
      - name: Deploy to server
        run: echo  "Deployed onto render"

  notify-on-failure:
    name: Notify on Failure
    runs-on: ubuntu-latest
    needs: [validate-code, build, test, deploy]
    if: failure()
    steps:
      - name: Notify on Failure
        uses: rtCamp/action-slack-notify@v3
        with:
          status: failure
          slack_webhook: ${{ secrets.DISCORD_WEBHOOK_URL }}
          message: |
            :exclamation: *Pipeline Failed* :exclamation:
            Workflow: ${{ github.workflow }}
            Branch: ${{ github.ref }}
            Commit: ${{ github.sha }}
            Author: ${{ github.actor }}
            Error: ${{ job.status }}